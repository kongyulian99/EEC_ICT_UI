<div class="dashboard-container">
  <!-- Header -->
  <!-- <div class="dashboard-header mb-4">
    <h2 class="mb-0">Home</h2>
  </div> -->

  <!-- Loading Spinner -->
  <div class="text-center py-5" *ngIf="isLoading">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Main Content -->
  <div class="dashboard-content" *ngIf="!isLoading">
    <!-- Overview -->
    <div class="card mb-4" *ngIf="historySummary">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Overview</h5>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-6 col-md-3">
            <div class="stats-card text-center p-3 bg-light rounded">
              <div class="stats-value">{{historySummary.TotalExams}}</div>
              <div class="stats-label">Exams Taken</div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="stats-card text-center p-3 bg-light rounded">
              <div class="stats-value">{{historySummary.TotalAttempts}}</div>
              <div class="stats-label">Total Attempts</div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="stats-card text-center p-3 bg-light rounded">
              <div class="stats-value text-success">{{historySummary.TotalPassed}}</div>
              <div class="stats-label">Passed</div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="stats-card text-center p-3 bg-light rounded">
              <div class="stats-value">{{historySummary.AverageScore | number:'1.1-1'}}</div>
              <div class="stats-label">Average Score (out of 10)</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- No data notification -->
    <div class="alert alert-info" *ngIf="!isLoading && (!examHistory || examHistory.length === 0)">
      <i class="fas fa-info-circle me-2"></i>
      You haven't taken any exams yet. Go to "Exams" section to start taking tests.
    </div>

    <!-- Statistics Charts -->
    <div class="row mb-4" *ngIf="examHistory && examHistory.length > 0">
      <div class="col-md-6 mb-4 mb-md-0">
        <div class="card h-100">
          <div class="card-header bg-light py-2">
            <h6 class="mb-0">Score Progress</h6>
          </div>
          <div class="card-body">
            <div class="text-center py-4" *ngIf="isLoadingCharts">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
            <div class="chart-container" *ngIf="!isLoadingCharts">
              <div *ngIf="progressData && progressData.length > 0">
                <div class="progress-chart">
                  <div class="line-chart-container">
                    <div class="y-axis">
                      <div class="y-axis-label" *ngFor="let value of [10, 8, 6, 4, 2, 0]">{{value}}</div>
                    </div>
                    <div class="chart-area">
                      <div class="horizontal-grid" *ngFor="let value of [10, 8, 6, 4, 2, 0]" [style.bottom.%]="(value/10)*100"></div>
                      <div class="data-points">
                        <div class="data-point" *ngFor="let point of progressData; let i = index"
                          [style.left.%]="(i / (progressData.length - 1)) * 100"
                          [style.bottom.%]="(point.AverageScore / 10) * 100">
                          <div class="point-marker"></div>
                          <div class="point-tooltip">
                            <div><b>{{point.Date}}</b></div>
                            <div>Score: <b>{{point.AverageScore | number:'1.1-1'}}</b></div>
                            <div>Attempts: {{point.AttemptCount}}</div>
                          </div>
                        </div>
                      </div>
                      <svg class="line-path" viewBox="0 0 100 100" preserveAspectRatio="none">
                        <polyline [attr.points]="getLineChartPoints(progressData)" stroke="#007bff" stroke-width="2" fill="none" />
                      </svg>
                    </div>
                  </div>
                  <div class="x-axis">
                    <div class="x-axis-label" *ngFor="let point of progressData; let i = index"
                      [style.left.%]="(i / (progressData.length - 1)) * 100">
                      {{point.Date}}
                    </div>
                  </div>
                </div>
                <div class="progress-summary mt-2" *ngIf="progressSummary">
                  <div class="alert alert-info py-2 px-3 mb-0">
                    <span class="me-2">First: <b>{{progressSummary.FirstScore | number:'1.1-1'}}</b></span>
                    <span class="me-2">Last: <b>{{progressSummary.LastScore | number:'1.1-1'}}</b></span>
                    <span>Improvement: <b [ngClass]="{'text-success': progressSummary.Improvement > 0, 'text-danger': progressSummary.Improvement < 0}">{{progressSummary.Improvement | number:'1.1-1'}} points ({{progressSummary.ImprovementPercentage | number:'1.1-1'}}%)</b></span>
                  </div>
                </div>
              </div>
              <div *ngIf="!progressData || progressData.length === 0" class="text-muted text-center py-4">
                <i class="fas fa-chart-line fa-3x mb-3"></i><br>
                Not enough data to display score progress
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card h-100">
          <div class="card-header bg-light py-2">
            <h6 class="mb-0">Score Distribution</h6>
          </div>
          <div class="card-body">
            <div class="text-center py-4" *ngIf="isLoadingCharts">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
            <div class="chart-container" *ngIf="!isLoadingCharts">
              <div *ngIf="scoreDistribution && scoreDistribution.length > 0">
                <div class="distribution-chart">
                  <div class="bar-chart-container">
                    <div class="bar-wrapper" *ngFor="let item of scoreDistribution; let i = index">
                      <div class="bar-label">{{item.RangeLabel}}</div>
                      <div class="bar-container">
                        <div class="bar" [style.height.%]="getBarHeight(item.Count, scoreDistribution)">
                          <div class="bar-tooltip">
                            <b>{{item.RangeLabel}}</b><br>
                            Count: <b>{{item.Count}}</b>
                          </div>
                        </div>
                        <div class="bar-value">{{item.Count}}</div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="distribution-summary mt-2" *ngIf="distributionSummary">
                  <div class="alert alert-info py-2 px-3 mb-0">
                    <span class="me-2">Average Score: <b>{{distributionSummary.AverageScore | number:'1.1-1'}}</b></span>
                    <span class="me-2">Pass Rate: <b>{{distributionSummary.PassRate | number:'1.1-1'}}%</b></span>
                    <span>Total Attempts: <b>{{distributionSummary.TotalAttempts}}</b></span>
                  </div>
                </div>
              </div>
              <div *ngIf="!scoreDistribution || scoreDistribution.length === 0" class="text-muted text-center py-4">
                <i class="fas fa-chart-bar fa-3x mb-3"></i><br>
                Not enough data to display score distribution
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Exam History -->
    <div class="card" *ngIf="examHistory && examHistory.length > 0">
      <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Recent Exam History</h5>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover mb-0 align-middle">
            <thead class="table-light">
              <tr>
                <th scope="col">#</th>
                <th scope="col">Exam</th>
                <th scope="col">Date</th>
                <th scope="col">Duration</th>
                <th scope="col">Score</th>
                <th scope="col">Result</th>
                <th scope="col">Status</th>
                <th scope="col">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let attempt of examHistory; let i = index">
                <td>{{i + 1}}</td>
                <td>{{attempt.ExamTitle}}</td>
                <td>{{formatDate(attempt.StartTime)}}</td>
                <td>{{attempt.DurationFormatted}}</td>
                <td class="fw-bold">{{attempt.Score}}/10</td>
                <td>
                  <span class="badge" [ngClass]="{'bg-success': attempt.Passed, 'bg-danger': !attempt.Passed}">
                    {{attempt.Passed ? 'Passed' : 'Failed'}}
                  </span>
                </td>
                <td>
                  <span class="badge bg-primary">{{attempt.CompletionStatus}}</span>
                </td>
                <td>
                  <button class="btn btn-sm btn-outline-primary me-1" (click)="viewAttemptDetail(attempt)">
                    <i class="fas fa-eye"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-success" (click)="startNewExam(attempt.ExamId)">
                    <i class="fas fa-redo"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
