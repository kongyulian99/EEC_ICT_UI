<div class="dashboard-container" *ngIf="!isLoading">
  <!-- Welcome Header -->
  <div class="welcome-header mb-4">
    <div class="d-flex align-items-center">
      <div class="avatar-container">
        <img [src]="userAvatar || 'assets/images/default-avatar.avif'"
          onerror="this.src='assets/images/default-avatar.avif'" alt="User Avatar" class="user-avatar">
      </div>
      <div>
        <h2 class="mb-0">Welcome back, {{ currentUser.Full_Name || 'Student' }}!</h2>
        <p class="text-muted mb-0">Let's continue your learning journey and conquer new challenges.</p>
      </div>
    </div>
    <div class="header-actions">
      <button class="btn btn-primary" (click)="goToExams()">
        <i class="fa fa-pencil-square-o me-2"></i>Start a New Exam
      </button>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="row g-4 mb-4" *ngIf="historySummary">
    <div class="col-lg-3 col-md-6">
      <div class="stats-card card-exams">
        <div class="card-icon"><i class="fa fa-file-text-o"></i></div>
        <div class="card-content">
          <p class="card-label">Exams Taken</p>
          <h3 class="card-value">{{ historySummary.TotalExams || 0 }}</h3>
        </div>
      </div>
    </div>
    <div class="col-lg-3 col-md-6">
      <div class="stats-card card-attempts">
        <div class="card-icon"><i class="fa fa-refresh"></i></div>
        <div class="card-content">
          <p class="card-label">Total Attempts</p>
          <h3 class="card-value">{{ historySummary.TotalAttempts || 0 }}</h3>
        </div>
      </div>
    </div>
    <div class="col-lg-3 col-md-6">
      <div class="stats-card card-passed">
        <div class="card-icon"><i class="fa fa-check"></i></div>
        <div class="card-content">
          <p class="card-label">Passed</p>
          <h3 class="card-value">{{ historySummary.TotalPassed || 0 }}</h3>
        </div>
      </div>
    </div>
    <div class="col-lg-3 col-md-6">
      <div class="stats-card card-score">
        <div class="card-icon"><i class="fa fa-star-half-o"></i></div>
        <div class="card-content">
          <p class="card-label">Average Score</p>
          <h3 class="card-value">{{ (historySummary.AverageScore | number:'1.1-1') || '0.0' }}</h3>
        </div>
      </div>
    </div>
  </div>

  <!-- Topic Performance Section -->
  <div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Topic Performance</h5>
      <div class="btn-group" role="group">
        <button type="button" class="btn btn-sm" [class.btn-primary]="selectedViewMode === 'treemap'" [class.btn-outline-primary]="selectedViewMode !== 'treemap'" (click)="changeViewMode('treemap')">
          <i class="fas fa-th-large"></i> TreeMap
        </button>
        <button type="button" class="btn btn-sm" [class.btn-primary]="selectedViewMode === 'radar'" [class.btn-outline-primary]="selectedViewMode !== 'radar'" (click)="changeViewMode('radar')">
          <i class="fas fa-chart-radar"></i> Radar
        </button>
      </div>
    </div>
    <div class="card-body">
      <div *ngIf="isLoadingTopicData" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="sr-only">Loading...</span>
        </div>
        <p class="mt-2">Loading topic performance data...</p>
      </div>

      <div *ngIf="!isLoadingTopicData">
        <!-- TreeMap View -->
        <div *ngIf="selectedViewMode === 'treemap'" class="treemap-container">
          <dx-tree-map
            id="treemap"
            [dataSource]="treeMapData"
            [title]="treeMapOptions.title"
            [tooltip]="treeMapOptions.tooltip"
            [colorizer]="treeMapOptions.colorizer"
            [interactWithGroup]="treeMapOptions.interactWithGroup"
            [layoutAlgorithm]="treeMapOptions.layoutAlgorithm"
            [maxDepth]="treeMapOptions.maxDepth"
            [layoutDirection]="treeMapOptions.layoutDirection">
          </dx-tree-map>
        </div>

        <!-- Radar Chart View -->
        <div *ngIf="selectedViewMode === 'radar'" class="radar-chart-container">
          <dx-polar-chart
            id="radar-chart"
            [dataSource]="radarChartData"
            [commonSeriesSettings]="{ type: 'line', closed: true }"
            [tooltip]="visualizationOptions.tooltip">

            <dxi-series
              name="Your Score"
              valueField="score"
              [width]="2"
              [point]="{ size: 7 }">
            </dxi-series>

            <dxi-series
              name="Ideal Score"
              valueField="idealScore"
              [width]="1"
              [point]="{ size: 4 }"
              [dashStyle]="'dash'">
            </dxi-series>

            <dxo-argument-axis
              [discreteAxisDivisionMode]="'crossLabels'"
              [firstPointOnStartAngle]="true">
              <dxo-label [overlappingBehavior]="'stagger'">
              </dxo-label>
            </dxo-argument-axis>

            <dxo-legend
              [visible]="true"
              [horizontalAlignment]="'center'"
              [verticalAlignment]="'bottom'">
            </dxo-legend>

            <dxo-export [enabled]="false"></dxo-export>
          </dx-polar-chart>
        </div>

        <!-- Topics Needing Improvement -->
        <div class="mt-4">
          <h6 class="mb-3">Topics Needing Improvement</h6>
          <div *ngIf="getTopicsNeedingImprovement().length === 0" class="alert alert-success">
            <i class="fas fa-check-circle mr-2"></i> Great job! You're doing well in all topics.
          </div>
          <div *ngFor="let topic of getTopicsNeedingImprovement()" class="topic-performance-item mb-2">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <div>
                <span class="topic-name">{{ topic.topicName }}</span>
                <span class="badge badge-pill ml-2" [ngClass]="{
                  'badge-danger': topic.avgScore < 5,
                  'badge-warning': topic.avgScore >= 5 && topic.avgScore < 7,
                  'badge-success': topic.avgScore >= 7
                }">{{ topic.avgScore }}/10</span>
              </div>
              <button class="btn btn-sm btn-outline-primary" (click)="goToTopicPractice(topic.topicId)">
                Practice
              </button>
            </div>
            <div class="progress" style="height: 8px;">
              <div class="progress-bar"
                  [ngClass]="{
                    'bg-danger': topic.avgScore < 5,
                    'bg-warning': topic.avgScore >= 5 && topic.avgScore < 7,
                    'bg-success': topic.avgScore >= 7
                  }"
                  [ngStyle]="{'width': getTopicPerformanceWidth(topic.avgScore) + '%'}">
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content Grid -->
  <div class="row g-4">
    <!-- Recent Exam History -->
    <div class="col-lg-8">
      <div class="card h-100 history-card">
        <div class="card-header">
          <h5 class="card-title mb-0"><i class="fa fa-history me-2"></i>Recent Exam History</h5>
        </div>
        <div class="card-body p-0">
          <div *ngIf="!isLoading && examHistory && examHistory.length > 0; else noHistoryTemplate">
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Exam</th>
                    <th class="text-center">Score</th>
                    <th class="text-center">Result</th>
                    <th>Date</th>
                    <th class="text-center">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let attempt of examHistory">
                    <td>
                      <div class="exam-name">{{ attempt.ExamTitle }}</div>
                      <div class="small text-muted">Attempt #{{ attempt.AttemptNumber }}</div>
                    </td>
                    <td class="text-center">
                      <div class="score-badge" [ngClass]="{'score-high': attempt.Score >= 8, 'score-mid': attempt.Score >= 5 && attempt.Score < 8, 'score-low': attempt.Score < 5}">
                        {{ attempt.Score }}
                      </div>
                    </td>
                    <td class="text-center">
                      <span class="badge" [ngClass]="{'bg-success': attempt.Passed, 'bg-danger': !attempt.Passed}">
                        {{ attempt.Passed ? 'Passed' : 'Failed' }}
                      </span>
                    </td>
                    <td>{{ formatDate(attempt.StartTime) }}</td>
                    <td class="text-center">
                      <div class="action-buttons">
                        <button class="btn btn-icon" title="View Details" (click)="viewAttemptDetail(attempt)">
                          <i class="fa fa-eye"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <ng-template #noHistoryTemplate>
            <div class="empty-state">
              <i class="fa fa-history empty-icon"></i>
              <h5 class="mt-3">No Exam History</h5>
              <p>You haven't taken any exams yet.</p>
              <button class="btn btn-outline-primary mt-2" (click)="goToExams()">
                Start Your First Exam
              </button>
            </div>
          </ng-template>
        </div>
      </div>
    </div>

    <!-- Score Distribution Chart -->
    <div class="col-lg-4">
      <div class="card h-100 chart-card">
        <div class="card-header">
          <h5 class="card-title mb-0"><i class="fa fa-bar-chart me-2"></i>Score Distribution</h5>
        </div>
        <div class="card-body">
          <div *ngIf="!isLoadingCharts && scoreDistribution && scoreDistribution.length > 0; else noChartDataTemplate">
            <div class="distribution-chart">
              <div class="bar-chart-container">
                <div class="bar-wrapper" *ngFor="let item of scoreDistribution">
                  <div class="bar-tooltip"><b>{{ item.RangeLabel }}</b><br>Count: <b>{{ item.Count }}</b></div>
                  <div class="bar" [style.height.%]="getBarHeight(item.Count, scoreDistribution)"></div>
                  <div class="bar-label">{{ item.RangeLabel }}</div>
                </div>
              </div>
            </div>
          </div>
          <ng-template #noChartDataTemplate>
            <div class="empty-state">
              <i class="fa fa-pie-chart empty-icon"></i>
              <h5 class="mt-3">Not Enough Data</h5>
              <p>Complete more exams to see your score distribution.</p>
            </div>
          </ng-template>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Loading Spinner -->
<div class="loading-overlay" *ngIf="isLoading">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
</div>
