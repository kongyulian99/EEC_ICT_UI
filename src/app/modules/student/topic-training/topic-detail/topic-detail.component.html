<div class="loading-container" *ngIf="isLoading">
  <div class="spinner-border text-primary" role="status"></div>
  <p class="mt-3">Đang tải câu hỏi...</p>
</div>
<div *ngIf="!isLoading && errorMessage" class="text-danger">{{ errorMessage }}</div>

<div class="exam-taking-container" *ngIf="!isLoading && !errorMessage">
  <!-- Header -->
  <div class="exam-header">
    <div class="container-fluid d-flex justify-content-between align-items-center">
      <h4 class="exam-title-header mb-0">Chủ đề #{{ topic?.Name || topicId }}</h4>
      <div class="d-flex align-items-center">
        <div class="exam-timer me-3">
          <i class="fa fa-question-circle me-2"></i>
          <span>{{ questions?.length || 0 }} câu hỏi</span>
        </div>
        <button class="btn btn-success submit-btn-header" (click)="submitExam()">
          <i class="fa fa-check me-2"></i>Lưu câu trả lời
        </button>
      </div>
    </div>
  </div>

  <!-- Nội dung chính -->
  <div class="container-fluid exam-body py-3">
    <div class="row g-4">
      <!-- Panel câu hỏi -->
      <div class="col-lg-8">
        <div class="card question-card" *ngIf="currentQuestion as cq">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
              Câu hỏi {{ currentQuestionIndex + 1 }}
              <span class="badge question-type-badge ms-2">{{ cq.Question_Type === questionTypes.MULTIPLE_CHOICE ? 'Multiple Choice' : (cq.Question_Type === questionTypes.TRUE_FALSE ? 'True/False' : 'Fill in the Blank') }}</span>
            </h5>
            <span class="badge bg-info">Điểm: {{ cq.Score }}</span>
          </div>
          <div class="card-body">
            <!-- Nội dung câu hỏi -->
            <div class="question-content mb-4 p-3 border rounded bg-light">
              <div *ngIf="cq.Question_Type !== questionTypes.FILL_IN_THE_BLANK" class="question-text">
                <div [innerHTML]="sanitizeHtml(cq.Content)"></div>
              </div>
              <div *ngIf="cq.Question_Type === questionTypes.FILL_IN_THE_BLANK" class="fill-blank-question">
                <ng-container *ngFor="let segment of getFillInBlankSegments(cq); let i = index">
                  <span [innerHTML]="sanitizeHtml(segment)"></span>
                  <ng-container *ngIf="i < getFillInBlankAnswers(cq).length">
                    <input type="text" class="form-control fill-blank-input d-inline-block"
                           [value]="userAnswers[cq.Id] ? userAnswers[cq.Id][i] : ''"
                           (input)="updateBlankAnswer(cq.Id, i, $any($event.target).value)">
                  </ng-container>
                </ng-container>
              </div>
            </div>

            <!-- Các lựa chọn đáp án -->
            <div class="answer-options" *ngIf="cq.Question_Type !== questionTypes.FILL_IN_THE_BLANK">
              <div *ngIf="cq.Question_Type === questionTypes.MULTIPLE_CHOICE" class="option-list">
                <div class="option-item d-flex align-items-start mb-2"
                     *ngFor="let option of getMultipleChoiceOptions(cq); let j = index"
                     [ngClass]="{'selected': userAnswers[cq.Id] === j}"
                     (click)="setMultipleChoiceAnswer(cq.Id, j)">
                  <span class="option-letter me-2">{{ getOptionLabel(j) }}</span>
                  <div class="option-text">{{ option }}</div>
                </div>
              </div>

              <div *ngIf="cq.Question_Type === questionTypes.TRUE_FALSE" class="option-list true-false-list">
                <div class="option-item d-flex align-items-start mb-2"
                     [ngClass]="{'selected': userAnswers[cq.Id] === true}"
                     (click)="setTrueFalseAnswer(cq.Id, true)">
                  <span class="option-letter me-2">A</span>
                  <div class="option-text">Đúng</div>
                </div>
                <div class="option-item d-flex align-items-start"
                     [ngClass]="{'selected': userAnswers[cq.Id] === false}"
                     (click)="setTrueFalseAnswer(cq.Id, false)">
                  <span class="option-letter me-2">B</span>
                  <div class="option-text">Sai</div>
                </div>
              </div>
            </div>
          </div>
          <!-- Điều hướng -->
          <div class="card-footer d-flex justify-content-between align-items-center">
            <button class="btn btn-outline-primary" [disabled]="currentQuestionIndex === 0" (click)="previousQuestion()">
              <i class="fa fa-chevron-left me-2"></i>Câu trước
            </button>
            <div class="question-counter">
              {{ currentQuestionIndex + 1 }} / {{ questions.length }}
            </div>
            <button class="btn btn-primary" [disabled]="currentQuestionIndex === questions.length - 1" (click)="nextQuestion()">
              Câu tiếp<i class="fa fa-chevron-right ms-2"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Thanh điều hướng -->
      <div class="col-lg-4">
        <div class="card question-nav-card">
          <div class="card-header bg-light">
            <h5 class="mb-0">Danh sách câu hỏi</h5>
          </div>
          <div class="card-body">
            <div class="question-navigation">
              <button *ngFor="let question of questions; let i = index"
                      class="question-number"
                      [ngClass]="{
                        'current': currentQuestionIndex === i,
                        'answered': isQuestionAnswered(question.Id),
                        'unanswered': !isQuestionAnswered(question.Id)
                      }"
                      (click)="goToQuestion(i)">
                {{ i + 1 }}
              </button>
            </div>
            <hr>
            <div class="nav-legend">
              <div class="legend-item"><span class="legend-color current"></span> Câu hiện tại</div>
              <div class="legend-item"><span class="legend-color answered"></span> Đã trả lời</div>
              <div class="legend-item"><span class="legend-color unanswered"></span> Chưa trả lời</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
